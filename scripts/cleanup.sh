#!/bin/bash

# Remove the artifacts bucket
gsutil rm -r "${ARTIFACT_BUCKET}"

# Delete the scheduler job
gcloud scheduler jobs delete "${SERVICE_NAME}-mirror-update" --location="${REGION}"

# Delete the event trigger
gcloud eventarc triggers delete "trigger-${BUCKET_NAME}-${SERVICE_NAME}" --location="${LOCATION}"

# Remove IAM policy bindings
gcloud projects remove-iam-policy-binding "${PROJECT_ID}" \
  --member "serviceAccount:${SERVICE_ACCOUNT}" \
  --role "roles/eventarc.eventReceiver"

gcloud run services remove-iam-policy-binding "${SERVICE_NAME}" \
  --region="${REGION}" \
  --member "serviceAccount:${SERVICE_ACCOUNT}" \
  --role "roles/run.invoker"
# fails

gcloud projects remove-iam-policy-binding "${PROJECT_ID}" \
  --member "serviceAccount:${SERVICE_ACCOUNT}" \
  --role "roles/pubsub.publisher"

gcloud projects remove-iam-policy-binding "${PROJECT_ID}" \
  --member "serviceAccount:${STORAGE_SERVICE_ACCOUNT}" \
  --role "roles/pubsub.publisher"

gcloud projects remove-iam-policy-binding "${PROJECT_ID}" \
  --member="serviceAccount:${PUBSUB_SERVICE_ACCOUNT}" \
  --role='roles/iam.serviceAccountTokenCreator'

gcloud projects remove-iam-policy-binding \
  "${PROJECT_ID}" \
  --member="serviceAccount:${SERVICE_ACCOUNT}" \
  --role="roles/monitoring.metricWriter"

# Delete the service account
gcloud iam service-accounts delete "${SERVICE_ACCOUNT}" --quiet

# Remove the content of the mirror bucket
gsutil rm -r "${CVD_MIRROR_BUCKET}"

# Remove the user files, quarantined, and unscanned buckets
gsutil rm -r "${CLEAN_BUCKET}"
gsutil rm -r "${QUARANTINED_BUCKET}"
gsutil rm -r "${UNSCANNED_BUCKET}"
